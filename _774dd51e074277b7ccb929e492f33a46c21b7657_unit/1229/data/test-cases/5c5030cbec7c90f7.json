{"uid":"5c5030cbec7c90f7","name":"test_connect_caching[True]","fullName":"tests.unit.db.test_connection#test_connect_caching","historyId":"d696a77f76f4bb8d897419f7b893e9d1","time":{"start":1720198859713,"stop":1720198859783,"duration":70},"status":"broken","statusMessage":"httpx.TimeoutException: No response can be found for POST request on /?output_format=JSON_Compact with b'USE DATABASE \"database\"' body amongst:\nMatch all requests on https://id.mock.firebolt.io/oauth/token\nMatch all requests on https://api-dev.mock.firebolt.io/web/v3/account/mock_account_name/engineUrl\nMatch all requests on re.compile('https:\\\\/\\\\/api-dev.mock.firebolt.io\\\\/web\\\\/v3\\\\/account\\\\/[^\\\\\\\\\\\\\\\\]*\\\\/resolve')\nMatch all requests on https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact with b'USE DATABASE \"database\"' body\nMatch all requests on https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact&database=database with b'USE ENGINE \"mock_engine_name\"' body\nMatch all requests on https://mock_engine_name.mock.firebolt.io/?output_format=JSON_Compact&database=database","statusTrace":"db_name = 'database', engine_name = 'mock_engine_name'\nauth_url = 'https://id.mock.firebolt.io/oauth/token'\napi_endpoint = 'api-dev.mock.firebolt.io'\nauth = <firebolt.client.auth.client_credentials.ClientCredentials object at 0x7fee1b843940>\naccount_name = 'mock_account_name'\nhttpx_mock = <pytest_httpx._httpx_mock.HTTPXMock object at 0x7fee1bd496d0>\ncheck_credentials_callback = <function check_credentials_callback.<locals>.check_credentials at 0x7fee1b56f700>\nget_system_engine_url = URL('https://api-dev.mock.firebolt.io/web/v3/account/mock_account_name/engineUrl')\nget_system_engine_callback = <function get_system_engine_callback.<locals>.inner at 0x7fee1b56f310>\naccount_id_url = re.compile('https:\\\\/\\\\/api-dev.mock.firebolt.io\\\\/web\\\\/v3\\\\/account\\\\/[^\\\\\\\\\\\\\\\\]*\\\\/resolve')\naccount_id_callback = <function account_id_callback.<locals>.do_mock at 0x7fee1b56f3a0>\nsystem_engine_query_url = 'https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact&database=database'\nsystem_engine_no_db_query_url = 'https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact'\nquery_url = URL('https://mock_engine_name.mock.firebolt.io/?output_format=JSON_Compact&database=database')\nuse_database_callback = <function use_database_callback.<locals>.inner at 0x7fee1c23d670>\nuse_engine_with_account_id_callback = <function use_engine_with_account_id_callback.<locals>.inner at 0x7fee1c23d700>\nquery_callback = <function query_callback.<locals>.do_query at 0x7fee1b59b550>\ncache_enabled = True\n\n    @mark.parametrize(\"cache_enabled\", [True, False])\n    def test_connect_caching(\n        db_name: str,\n        engine_name: str,\n        auth_url: str,\n        api_endpoint: str,\n        auth: Auth,\n        account_name: str,\n        httpx_mock: HTTPXMock,\n        check_credentials_callback: Callable,\n        get_system_engine_url: str,\n        get_system_engine_callback: Callable,\n        account_id_url: str,\n        account_id_callback: Callable,\n        system_engine_query_url: str,\n        system_engine_no_db_query_url: str,\n        query_url: str,\n        use_database_callback: Callable,\n        use_engine_with_account_id_callback: Callable,\n        query_callback: Callable,\n        cache_enabled: bool,\n    ):\n        system_engine_call_counter = 0\n        account_id_call_counter = 0\n    \n        def system_engine_callback_counter(request, **kwargs):\n            nonlocal system_engine_call_counter\n            system_engine_call_counter += 1\n            return get_system_engine_callback(request, **kwargs)\n    \n        def account_id_callback_counter(request, **kwargs):\n            nonlocal account_id_call_counter\n            account_id_call_counter += 1\n            return account_id_callback(request, **kwargs)\n    \n        httpx_mock.add_callback(check_credentials_callback, url=auth_url)\n        httpx_mock.add_callback(system_engine_callback_counter, url=get_system_engine_url)\n        httpx_mock.add_callback(account_id_callback_counter, url=account_id_url)\n        httpx_mock.add_callback(\n            use_database_callback,\n            url=system_engine_no_db_query_url,\n            match_content=f'USE DATABASE \"{db_name}\"'.encode(\"utf-8\"),\n        )\n    \n        httpx_mock.add_callback(\n            use_engine_with_account_id_callback,\n            url=system_engine_query_url,\n            match_content=f'USE ENGINE \"{engine_name}\"'.encode(\"utf-8\"),\n        )\n        httpx_mock.add_callback(query_callback, url=query_url)\n    \n        for _ in range(3):\n>           with connect(\n                database=db_name,\n                engine_name=engine_name,\n                auth=auth,\n                account_name=account_name,\n                api_endpoint=api_endpoint,\n                disable_cache=not cache_enabled,\n            ) as connection:\n\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/tests/unit/db/test_connection.py:308: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/src/firebolt/db/connection.py:56: in connect\n    return connect_v2(\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/src/firebolt/db/connection.py:135: in connect_v2\n    cursor.execute(f'USE DATABASE \"{database}\"')\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/src/firebolt/common/base_cursor.py:122: in inner\n    return func(self, *args, **kwargs)\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/src/firebolt/db/cursor.py:237: in execute\n    self._do_execute(query, params_list, skip_parsing)\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/src/firebolt/db/cursor.py:183: in _do_execute\n    resp = self._api_request(\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/src/firebolt/db/cursor.py:333: in _api_request\n    return self._client.request(\n/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/httpx/_client.py:814: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\n/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/httpx/_client.py:901: in send\n    response = self._send_handling_auth(\n/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/httpx/_client.py:929: in _send_handling_auth\n    response = self._send_handling_redirects(\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/src/firebolt/client/client.py:135: in _send_handling_redirects\n    return super()._send_handling_redirects(\n/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/httpx/_client.py:966: in _send_handling_redirects\n    response = self._send_single_request(request)\n/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/httpx/_client.py:1002: in _send_single_request\n    response = transport.handle_request(request)\n/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/pytest_httpx/_httpx_mock.py:326: in handle_request\n    return self.mock._handle_request(*args, **kwargs)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <pytest_httpx._httpx_mock.HTTPXMock object at 0x7fee1bd496d0>\nrequest = <Request('POST', '/?output_format=JSON_Compact')>\n\n    def _handle_request(\n        self,\n        request: httpx.Request,\n    ) -> httpx.Response:\n        self._requests.append(request)\n    \n        callback = self._get_callback(request)\n        if callback:\n            response = callback(request)\n    \n            if response:\n                return _unread(response)\n    \n>       raise httpx.TimeoutException(\n            self._explain_that_no_response_was_found(request), request=request\n        )\nE       httpx.TimeoutException: No response can be found for POST request on /?output_format=JSON_Compact with b'USE DATABASE \"database\"' body amongst:\nE       Match all requests on https://id.mock.firebolt.io/oauth/token\nE       Match all requests on https://api-dev.mock.firebolt.io/web/v3/account/mock_account_name/engineUrl\nE       Match all requests on re.compile('https:\\\\/\\\\/api-dev.mock.firebolt.io\\\\/web\\\\/v3\\\\/account\\\\/[^\\\\\\\\\\\\\\\\]*\\\\/resolve')\nE       Match all requests on https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact with b'USE DATABASE \"database\"' body\nE       Match all requests on https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact&database=database with b'USE ENGINE \"mock_engine_name\"' body\nE       Match all requests on https://mock_engine_name.mock.firebolt.io/?output_format=JSON_Compact&database=database\n\n/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/pytest_httpx/_httpx_mock.py:192: TimeoutException","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"clear_cache","time":{"start":1720198859679,"stop":1720198859679,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"global_fake_fs","time":{"start":1720198859679,"stop":1720198859681,"duration":2},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"db_name","time":{"start":1720198859681,"stop":1720198859681,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"client_id","time":{"start":1720198859682,"stop":1720198859682,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"auth_endpoint","time":{"start":1720198859682,"stop":1720198859682,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"client_secret","time":{"start":1720198859682,"stop":1720198859682,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"engine_name","time":{"start":1720198859682,"stop":1720198859682,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"api_endpoint","time":{"start":1720198859682,"stop":1720198859682,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"auth_url","time":{"start":1720198859682,"stop":1720198859682,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"auth","time":{"start":1720198859683,"stop":1720198859708,"duration":25},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"account_name","time":{"start":1720198859708,"stop":1720198859708,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"monkeypatch","time":{"start":1720198859708,"stop":1720198859708,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"assert_all_responses_were_requested","time":{"start":1720198859708,"stop":1720198859708,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"httpx_mock","time":{"start":1720198859708,"stop":1720198859709,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"non_mocked_hosts","time":{"start":1720198859708,"stop":1720198859708,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"check_credentials_callback","time":{"start":1720198859709,"stop":1720198859709,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"access_token","time":{"start":1720198859709,"stop":1720198859709,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_url","time":{"start":1720198859709,"stop":1720198859709,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"get_system_engine_callback","time":{"start":1720198859709,"stop":1720198859709,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"get_system_engine_url","time":{"start":1720198859709,"stop":1720198859709,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_query_url","time":{"start":1720198859710,"stop":1720198859710,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"account_id_url","time":{"start":1720198859710,"stop":1720198859710,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_no_db_query_url","time":{"start":1720198859710,"stop":1720198859710,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"account_id_callback","time":{"start":1720198859710,"stop":1720198859710,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"account_id","time":{"start":1720198859710,"stop":1720198859710,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"engine_url","time":{"start":1720198859710,"stop":1720198859710,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_data","time":{"start":1720198859711,"stop":1720198859712,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_statistics","time":{"start":1720198859711,"stop":1720198859711,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_url","time":{"start":1720198859711,"stop":1720198859711,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_description","time":{"start":1720198859711,"stop":1720198859711,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"use_engine_with_account_id_callback","time":{"start":1720198859711,"stop":1720198859711,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"use_database_callback","time":{"start":1720198859711,"stop":1720198859711,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_callback","time":{"start":1720198859712,"stop":1720198859712,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"afterStages":[{"name":"httpx_mock::0","time":{"start":1720198859943,"stop":1720198859943,"duration":0},"status":"failed","statusMessage":"AssertionError: The following responses are mocked but not requested:\n  Match all requests on re.compile('https:\\\\/\\\\/api-dev.mock.firebolt.io\\\\/web\\\\/v3\\\\/account\\\\/[^\\\\\\\\\\\\\\\\]*\\\\/resolve')\n  Match all requests on https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact with b'USE DATABASE \"database\"' body\n  Match all requests on https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact&database=database with b'USE ENGINE \"mock_engine_name\"' body\n  Match all requests on https://mock_engine_name.mock.firebolt.io/?output_format=JSON_Compact&database=database\nassert not [<pytest_httpx._httpx_mock._RequestMatcher object at 0x7fee1b4050a0>, <pytest_httpx._httpx_mock._RequestMatcher object...px_mock._RequestMatcher object at 0x7fee1bc25dc0>, <pytest_httpx._httpx_mock._RequestMatcher object at 0x7fee1b9a5a00>]\n","statusTrace":"  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/allure_commons/_allure.py\", line 221, in __call__\n    return self._fixture_function(*args, **kwargs)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/_pytest/fixtures.py\", line 916, in _teardown_yield_fixture\n    next(it)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/pytest_httpx/__init__.py\", line 65, in httpx_mock\n    mock.reset(assert_all_responses_were_requested)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/pytest_httpx/_httpx_mock.py\", line 309, in reset\n    assert (\n","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":true,"stepsCount":0,"attachmentsCount":0,"hasContent":true,"attachmentStep":false},{"name":"monkeypatch::0","time":{"start":1720198859944,"stop":1720198859944,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"global_fake_fs::0","time":{"start":1720198859948,"stop":1720198859949,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"labels":[{"name":"parentSuite","value":"tests.unit.db"},{"name":"suite","value":"test_connection"},{"name":"host","value":"fv-az654-356"},{"name":"thread","value":"2136-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.unit.db.test_connection"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"cache_enabled","value":"True"}],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Test defects","matchedStatuses":[],"flaky":false}],"tags":[]},"source":"5c5030cbec7c90f7.json","parameterValues":["True"]}