{"uid":"eed8c2665451f34a","name":"test_connection_cache_isolation_by_credentials[True]","fullName":"tests.unit.db.test_caching#test_connection_cache_isolation_by_credentials","historyId":"905a59a7fd6fbee7e9135ec408484197","time":{"start":1763477332054,"stop":1763477332108,"duration":54},"description":"Test that connections with different credentials are cached separately.","descriptionHtml":"<p>Test that connections with different credentials are cached separately.</p>\n","status":"failed","statusMessage":"AssertionError: Invalid id\nassert 'client_id=client_id' in 'client_id=client_1&client_secret=secret_1&grant_type=client_credentials&audience=https%3A%2F%2Fapi.firebolt.io'","statusTrace":"db_name = 'database', engine_name = 'mock_engine_name'\nauth_url = 'https://id.mock.firebolt.io/oauth/token'\nhttpx_mock = <pytest_httpx._httpx_mock.HTTPXMock object at 0x7fc0604914f0>\ncheck_credentials_callback = <function check_credentials_callback.<locals>.check_credentials at 0x7fc05d9a4310>\nget_system_engine_url = URL('https://api-dev.mock.firebolt.io/web/v3/account/mock_account_name/engineUrl')\nget_system_engine_callback = <function get_system_engine_callback.<locals>.inner at 0x7fc05d9a4f70>\nsystem_engine_query_url = 'https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact&database=database'\nsystem_engine_no_db_query_url = 'https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact'\nquery_url = URL('https://mock_engine_name.mock.firebolt.io/?output_format=JSON_Compact&database=database')\nuse_database_callback = <function use_database_callback.<locals>.inner at 0x7fc05d9a40d0>\nuse_engine_callback = <function use_engine_callback.<locals>.inner at 0x7fc05d9a4b80>\nquery_callback = <function query_callback.<locals>.do_query at 0x7fc05d9a49d0>\naccount_name = 'mock_account_name', api_endpoint = 'api-dev.mock.firebolt.io'\nuse_cache = True\n\n    @mark.parametrize(\"use_cache\", [True, False])\n    def test_connection_cache_isolation_by_credentials(\n        db_name: str,\n        engine_name: str,\n        auth_url: str,\n        httpx_mock: HTTPXMock,\n        check_credentials_callback: Callable,\n        get_system_engine_url: str,\n        get_system_engine_callback: Callable,\n        system_engine_query_url: str,\n        system_engine_no_db_query_url: str,\n        query_url: str,\n        use_database_callback: Callable,\n        use_engine_callback: Callable,\n        query_callback: Callable,\n        account_name: str,\n        api_endpoint: str,\n        use_cache: bool,\n    ):\n        \"\"\"Test that connections with different credentials are cached separately.\"\"\"\n    \n        # Create two different auth objects\n        auth1 = ClientCredentials(\n            client_id=\"client_1\", client_secret=\"secret_1\", use_token_cache=use_cache\n        )\n        auth2 = ClientCredentials(\n            client_id=\"client_2\", client_secret=\"secret_2\", use_token_cache=use_cache\n        )\n    \n        system_engine_call_counter = 0\n    \n        def system_engine_callback_counter(request, **kwargs):\n            nonlocal system_engine_call_counter\n            system_engine_call_counter += 1\n            return get_system_engine_callback(request, **kwargs)\n    \n        # Set up mocks for both auth credentials\n        httpx_mock.add_callback(check_credentials_callback, url=auth_url, is_reusable=True)\n        httpx_mock.add_callback(\n            system_engine_callback_counter,\n            url=get_system_engine_url,\n            is_reusable=True,\n        )\n        httpx_mock.add_callback(\n            use_database_callback,\n            url=system_engine_no_db_query_url,\n            match_content=f'USE DATABASE \"{db_name}\"'.encode(\"utf-8\"),\n            is_reusable=True,\n        )\n        httpx_mock.add_callback(\n            use_engine_callback,\n            url=system_engine_query_url,\n            match_content=f'USE ENGINE \"{engine_name}\"'.encode(\"utf-8\"),\n            is_reusable=True,\n        )\n        httpx_mock.add_callback(\n            query_callback,\n            url=query_url,\n            is_reusable=True,\n        )\n    \n        # Connect with first credentials\n>       with connect(\n            database=db_name,\n            engine_name=engine_name,\n            auth=auth1,\n            account_name=account_name,\n            api_endpoint=api_endpoint,\n            disable_cache=not use_cache,\n        ) as connection:\n\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/tests/unit/db/test_caching.py:752: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/src/firebolt/db/connection.py:97: in connect\n    return connect_v2(\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/src/firebolt/db/connection.py:158: in connect_v2\n    system_engine_info = _get_system_engine_url_and_params(\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/src/firebolt/db/connection.py:558: in _get_system_engine_url_and_params\n    response = client.get(url=url)\n/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/httpx/_client.py:1053: in get\n    return self.request(\n/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/httpx/_client.py:825: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\n/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/httpx/_client.py:914: in send\n    response = self._send_handling_auth(\n/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/httpx/_client.py:942: in _send_handling_auth\n    response = self._send_handling_redirects(\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/src/firebolt/client/client.py:123: in _send_handling_redirects\n    return super()._send_handling_redirects(\n/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/httpx/_client.py:979: in _send_handling_redirects\n    response = self._send_single_request(request)\n/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/httpx/_client.py:1014: in _send_single_request\n    response = transport.handle_request(request)\n/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/pytest_httpx/__init__.py:40: in mocked_handle_request\n    return mock._handle_request(transport, request)\n/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/pytest_httpx/_httpx_mock.py:158: in _handle_request\n    response = callback(request)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nrequest = <AuthRequest('POST', 'https://id.mock.firebolt.io/oauth/token')>\nkwargs = {}\nbody = 'client_id=client_1&client_secret=secret_1&grant_type=client_credentials&audience=https%3A%2F%2Fapi.firebolt.io'\n@py_assert0 = 'client_id=client_id', @py_assert2 = False\n@py_format4 = \"'client_id=client_id' in 'client_id=client_1&client_secret=secret_1&grant_type=client_credentials&audience=https%3A%2F%2Fapi.firebolt.io'\"\n@py_format6 = \"Invalid id\\n>assert 'client_id=client_id' in 'client_id=client_1&client_secret=secret_1&grant_type=client_credentials&audience=https%3A%2F%2Fapi.firebolt.io'\"\n\n    def check_credentials(\n        request: httpx.Request = None,\n        **kwargs,\n    ) -> Response:\n        assert request, \"empty request\"\n        body = request.read().decode(\"utf-8\")\n        assert \"client_id\" in body, \"Missing id\"\n>       assert f\"client_id={client_id}\" in body, \"Invalid id\"\nE       AssertionError: Invalid id\nE       assert 'client_id=client_id' in 'client_id=client_1&client_secret=secret_1&grant_type=client_credentials&audience=https%3A%2F%2Fapi.firebolt.io'\n\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/tests/unit/conftest.py:214: AssertionError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"pytestconfig","time":{"start":1763477277486,"stop":1763477277486,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"insert_assert_add_to_builtins","time":{"start":1763477277486,"stop":1763477277486,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"insert_assert_session","time":{"start":1763477277486,"stop":1763477277486,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"clear_cache","time":{"start":1763477332046,"stop":1763477332046,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"global_fake_fs","time":{"start":1763477332046,"stop":1763477332048,"duration":2},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"disable_cache","time":{"start":1763477332046,"stop":1763477332046,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"insert_assert_maybe_fail","time":{"start":1763477332046,"stop":1763477332046,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"engine_name","time":{"start":1763477332049,"stop":1763477332049,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"auth_url","time":{"start":1763477332049,"stop":1763477332049,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"monkeypatch","time":{"start":1763477332049,"stop":1763477332049,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"httpx_mock","time":{"start":1763477332049,"stop":1763477332050,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"auth_endpoint","time":{"start":1763477332049,"stop":1763477332049,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"db_name","time":{"start":1763477332049,"stop":1763477332049,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"access_token","time":{"start":1763477332050,"stop":1763477332050,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"account_name","time":{"start":1763477332050,"stop":1763477332051,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"client_secret","time":{"start":1763477332050,"stop":1763477332050,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"check_credentials_callback","time":{"start":1763477332050,"stop":1763477332050,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"client_id","time":{"start":1763477332050,"stop":1763477332050,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"api_endpoint","time":{"start":1763477332050,"stop":1763477332050,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"get_system_engine_callback","time":{"start":1763477332051,"stop":1763477332051,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_url","time":{"start":1763477332051,"stop":1763477332051,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_query_url","time":{"start":1763477332051,"stop":1763477332051,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_no_db_query_url","time":{"start":1763477332051,"stop":1763477332051,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"get_system_engine_url","time":{"start":1763477332051,"stop":1763477332051,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"use_engine_callback","time":{"start":1763477332052,"stop":1763477332052,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"use_database_callback","time":{"start":1763477332052,"stop":1763477332052,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_statistics","time":{"start":1763477332052,"stop":1763477332052,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"engine_url","time":{"start":1763477332052,"stop":1763477332052,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_url","time":{"start":1763477332052,"stop":1763477332052,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_callback","time":{"start":1763477332053,"stop":1763477332053,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_data","time":{"start":1763477332053,"stop":1763477332053,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_description","time":{"start":1763477332053,"stop":1763477332053,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"use_cache","time":{"start":1763477332598,"stop":1763477332598,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"afterStages":[{"name":"monkeypatch::0","time":{"start":1763477332278,"stop":1763477332279,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"httpx_mock::0","time":{"start":1763477332278,"stop":1763477332278,"duration":0},"status":"failed","statusMessage":"AssertionError: The following responses are mocked but not requested:\n  - Match every request on https://api-dev.mock.firebolt.io/web/v3/account/mock_account_name/engineUrl\n  - Match every request on https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact with b'USE DATABASE \"database\"' body\n  - Match every request on https://bravo.a.eu-west-1.aws.mock.firebolt.io/?output_format=JSON_Compact&database=database with b'USE ENGINE \"mock_engine_name\"' body\n  - Match every request on https://mock_engine_name.mock.firebolt.io/?output_format=JSON_Compact&database=database\n  \n  If this is on purpose, refer to https://github.com/Colin-b/pytest_httpx/blob/master/README.md#allow-to-register-more-responses-than-what-will-be-requested\nassert not [<pytest_httpx._request_matcher._RequestMatcher object at 0x7fc0604bae80>, <pytest_httpx._request_matcher._RequestMatc...er._RequestMatcher object at 0x7fc0604baf10>, <pytest_httpx._request_matcher._RequestMatcher object at 0x7fc0604ba3a0>]\n","statusTrace":"  File \"/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/allure_commons/_allure.py\", line 231, in __call__\n    return self._fixture_function(*args, **kwargs)\n  File \"/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/_pytest/fixtures.py\", line 938, in _teardown_yield_fixture\n    next(it)\n  File \"/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/pytest_httpx/__init__.py\", line 67, in httpx_mock\n    mock._assert_options()\n  File \"/opt/hostedtoolcache/Python/3.9.25/x64/lib/python3.9/site-packages/pytest_httpx/_httpx_mock.py\", line 319, in _assert_options\n    assert not callbacks_not_executed, (\n","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":true,"attachmentsCount":0,"hasContent":true,"attachmentStep":false},{"name":"global_fake_fs::0","time":{"start":1763477332281,"stop":1763477332281,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"insert_assert_maybe_fail::0","time":{"start":1763477332282,"stop":1763477332282,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"use_cache::0","time":{"start":1763477332854,"stop":1763477332854,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"insert_assert_session::0","time":{"start":1763477356326,"stop":1763477356326,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"labels":[{"name":"parentSuite","value":"tests.unit.db"},{"name":"suite","value":"test_caching"},{"name":"host","value":"runnervmg1sw1"},{"name":"thread","value":"2443-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.unit.db.test_caching"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"use_cache","value":"True"}],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[],"flaky":false}],"tags":[]},"source":"eed8c2665451f34a.json","parameterValues":["True"]}