{"uid":"3d47195d2c12c9d5","name":"test_database_switching_with_same_engine","fullName":"tests.unit.async_db.test_caching#test_database_switching_with_same_engine","historyId":"07546bb66a4d5cf02e3f7b1eede052e5","time":{"start":1764177509661,"stop":1764177509661,"duration":0},"description":"\n    Test that we can switch between different databases using the same engine\n    while maintaining proper database context for each cursor.\n    ","descriptionHtml":"<pre><code>Test that we can switch between different databases using the same engine\nwhile maintaining proper database context for each cursor.\n</code></pre>\n","status":"broken","statusMessage":"_pytest.fixtures.FixtureLookupError: ('second_db_name', <FixtureRequest for <Function test_database_switching_with_same_engine>>)","statusTrace":"file /home/runner/work/firebolt-python-sdk/firebolt-python-sdk/tests/unit/async_db/test_caching.py, line 1118\n  async def test_database_switching_with_same_engine(\n      db_name: str,\n      second_db_name: str,\n      engine_name: str,\n      auth_url: str,\n      httpx_mock: HTTPXMock,\n      check_credentials_callback: Callable,\n      get_system_engine_url: str,\n      get_system_engine_callback: Callable,\n      system_engine_query_url: str,\n      system_engine_no_db_query_url: str,\n      use_db_callback: Callable,\n      use_engine_callback: Callable,\n      query_callback: Callable,\n      query_url: str,\n      auth: Auth,\n      account_name: str,\n      api_endpoint: str,\n  ):\n      \"\"\"\n      Test that we can switch between different databases using the same engine\n      while maintaining proper database context for each cursor.\n      \"\"\"\n      # Mock HTTP calls\n      httpx_mock.add_callback(check_credentials_callback, url=auth_url, is_reusable=True)\n      httpx_mock.add_callback(\n          get_system_engine_callback,\n          url=get_system_engine_url,\n          is_reusable=True,\n      )\n\n      # Add USE DATABASE callbacks for both databases\n      httpx_mock.add_callback(\n          use_db_callback,\n          url=system_engine_no_db_query_url,\n          match_content=f'USE DATABASE \"{db_name}\"'.encode(\"utf-8\"),\n          is_reusable=True,\n      )\n      httpx_mock.add_callback(\n          use_db_callback,\n          url=system_engine_no_db_query_url,\n          match_content=f'USE DATABASE \"{second_db_name}\"'.encode(\"utf-8\"),\n          is_reusable=True,\n      )\n\n      # Add USE ENGINE callback\n      httpx_mock.add_callback(\n          use_engine_callback,\n          url=system_engine_query_url,\n          match_content=f'USE ENGINE \"{engine_name}\"'.encode(\"utf-8\"),\n          is_reusable=True,\n      )\n      httpx_mock.add_callback(\n          query_callback,\n          url=query_url,\n          is_reusable=True,\n      )\n\n      # Also add callback for second database query URL\n      second_query_url = query_url.copy_with(\n          params={**query_url.params, \"database\": second_db_name}\n      )\n      httpx_mock.add_callback(\n          query_callback,\n          url=second_query_url,\n          is_reusable=True,\n      )\n\n      # First connection: database1 + engine1\n      async with await connect(\n          database=db_name,\n          engine_name=engine_name,\n          auth=auth,\n          account_name=account_name,\n          api_endpoint=api_endpoint,\n      ) as connection1:\n          cursor1 = connection1.cursor()\n          await cursor1.execute(\"SELECT 1\")\n\n          # Verify first connection has correct database\n          assert (\n              cursor1.database == db_name\n          ), f\"First cursor should have database {db_name}\"\n\n          # Verify cache contains first database\n          cache_record = cursor1.get_cache_record()\n          assert cache_record is not None, \"Cache should have connection info\"\n          assert (\n              db_name in cache_record.databases\n          ), f\"Cache should contain database {db_name}\"\n\n      # Second connection: database2 + engine1 (same engine)\n      async with await connect(\n          database=second_db_name,\n          engine_name=engine_name,\n          auth=auth,\n          account_name=account_name,\n          api_endpoint=api_endpoint,\n      ) as connection2:\n          cursor2 = connection2.cursor()\n          await cursor2.execute(\"SELECT 1\")\n\n          # Verify second connection has correct database\n          assert cursor2.database == second_db_name, (\n              f\"Second cursor should have database {second_db_name}, \"\n              f\"but has {cursor2.database}. This indicates the database context was overwritten.\"\n          )\n\n          # Verify cache contains both databases\n          cache_record = cursor2.get_cache_record()\n          assert cache_record is not None, \"Cache should have connection info\"\n          assert (\n              db_name in cache_record.databases\n          ), f\"Cache should still contain database {db_name}\"\n          assert (\n              second_db_name in cache_record.databases\n          ), f\"Cache should contain database {second_db_name}\"\n\n      # Third connection: back to database1 + engine1 (should use cache)\n      async with await connect(\n          database=db_name,\n          engine_name=engine_name,\n          auth=auth,\n          account_name=account_name,\n          api_endpoint=api_endpoint,\n      ) as connection3:\n          cursor3 = connection3.cursor()\n          await cursor3.execute(\"SELECT 1\")\n\n          # Verify third connection has correct database (should be from cache)\n          assert cursor3.database == db_name, (\n              f\"Third cursor should have database {db_name}, \"\n              f\"but has {cursor3.database}. This indicates cached database context is incorrect.\"\n          )\nE       fixture 'second_db_name' not found\n>       available fixtures: access_token, access_token_2, account_id, account_name, account_version, anyio_backend, anyio_backend_name, anyio_backend_options, api_endpoint, async_multiple_query_data, async_query_callback, async_query_callback_factory, async_query_data, async_query_meta, async_query_status_running_callback, async_query_url, async_token, auth, auth_callback, auth_endpoint, auth_url, autojump_clock, begin_transaction_callback, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, check_credentials_callback, check_token_callback, class_mocker, clear_cache, client, client_id, client_secret, commit_transaction_callback, connection, connection_autocommit_off, connection_test, cov, cursor, db_api_exceptions, db_name, db_name_updated, disable_cache, doctest_namespace, dynamic_use_database_callback, enable_cache, engine_name, engine_url, env_name, fb_numeric_async_callback, fb_numeric_callback_factory, fb_numeric_expected_query_params, fb_numeric_paramstyle, fb_numeric_query_url, fb_numeric_query_url_exact, fb_numeric_simple_callback, fb_numeric_test_parameters, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, fs, fs_class, fs_module, fs_session, get_system_engine_404_callback, get_system_engine_callback, get_system_engine_url, global_fake_fs, httpx_mock, insert_assert, insert_assert_add_to_builtins, insert_assert_maybe_fail, insert_assert_session, insert_query_callback, mock_clock, mock_connection_flow, mock_insert_query, mock_query, mock_system_engine_connection_flow, mocker, module_mocker, monkeypatch, no_cover, nursery, package_mocker, pytestconfig, python_query_data, python_query_description, query_callback, query_callback_with_headers, query_callback_with_remove_header, query_data, query_description, query_statistics, query_url, query_url_updated, query_with_params_callback, record_property, record_testsuite_property, record_xml_attribute, recwarn, region_string, remove_parameters, rollback_transaction_callback, select_one_query_callback, session_mocker, set_params, set_query_url, settings, simple_commit_callback, streaming_error_query_callback, streaming_error_query_response, streaming_insert_query_callback, streaming_insert_query_response, streaming_query_callback, streaming_query_response, streaming_query_url, streaming_result_columns, system_engine_no_db_query_url, system_engine_query_url, system_engine_url, test_update_parameters, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, transaction_id, transaction_query_callback, transaction_sequence_id, transaction_with_remove_params_callback, types_map, use_cache, use_database_callback, use_database_failed_callback, use_engine_callback, use_engine_failed_callback, use_engine_with_params_callback, worker_id\n>       use 'pytest --fixtures [testpath]' for help on them.\n\n/home/runner/work/firebolt-python-sdk/firebolt-python-sdk/tests/unit/async_db/test_caching.py:1118","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"pytestconfig","time":{"start":1764177492065,"stop":1764177492066,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"insert_assert_add_to_builtins","time":{"start":1764177492065,"stop":1764177492065,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"insert_assert_session","time":{"start":1764177492066,"stop":1764177492066,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"disable_cache","time":{"start":1764177509662,"stop":1764177509662,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"global_fake_fs","time":{"start":1764177509662,"stop":1764177509665,"duration":3},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"clear_cache","time":{"start":1764177509662,"stop":1764177509662,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"insert_assert_maybe_fail","time":{"start":1764177509662,"stop":1764177509662,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"use_cache","time":{"start":1764177509665,"stop":1764177509665,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"enable_cache","time":{"start":1764177509665,"stop":1764177509665,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"db_name","time":{"start":1764177509666,"stop":1764177509666,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"auth_endpoint","time":{"start":1764177509684,"stop":1764177509684,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"auth_url","time":{"start":1764177509684,"stop":1764177509685,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"engine_name","time":{"start":1764177509684,"stop":1764177509684,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"monkeypatch","time":{"start":1764177509685,"stop":1764177509685,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"access_token","time":{"start":1764177509685,"stop":1764177509685,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"httpx_mock","time":{"start":1764177509685,"stop":1764177509685,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"client_id","time":{"start":1764177509685,"stop":1764177509685,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"check_credentials_callback","time":{"start":1764177509685,"stop":1764177509686,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"client_secret","time":{"start":1764177509685,"stop":1764177509685,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"get_system_engine_callback","time":{"start":1764177509686,"stop":1764177509686,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"get_system_engine_url","time":{"start":1764177509686,"stop":1764177509686,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_url","time":{"start":1764177509686,"stop":1764177509686,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"account_name","time":{"start":1764177509686,"stop":1764177509686,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_query_url","time":{"start":1764177509686,"stop":1764177509687,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"api_endpoint","time":{"start":1764177509686,"stop":1764177509686,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"engine_url","time":{"start":1764177509687,"stop":1764177509687,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_no_db_query_url","time":{"start":1764177509687,"stop":1764177509687,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_statistics","time":{"start":1764177509687,"stop":1764177509687,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"auth","time":{"start":1764177509688,"stop":1764177509701,"duration":13},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_description","time":{"start":1764177509688,"stop":1764177509688,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_callback","time":{"start":1764177509688,"stop":1764177509688,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_data","time":{"start":1764177509688,"stop":1764177509688,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"use_engine_callback","time":{"start":1764177509891,"stop":1764177509891,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_url","time":{"start":1764177510147,"stop":1764177510147,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_statistics","time":{"start":1764177549871,"stop":1764177549871,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_description","time":{"start":1764177549871,"stop":1764177549871,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_data","time":{"start":1764177549871,"stop":1764177549871,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"get_system_engine_url","time":{"start":1764177549926,"stop":1764177549926,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_url","time":{"start":1764177549926,"stop":1764177549926,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"get_system_engine_callback","time":{"start":1764177549926,"stop":1764177549927,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_no_db_query_url","time":{"start":1764177549927,"stop":1764177549927,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_url","time":{"start":1764177549927,"stop":1764177549927,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"system_engine_query_url","time":{"start":1764177549927,"stop":1764177549927,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"use_engine_callback","time":{"start":1764177549928,"stop":1764177549928,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"query_callback","time":{"start":1764177549928,"stop":1764177549928,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"afterStages":[{"name":"use_cache::0","time":{"start":1764177509676,"stop":1764177509676,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"enable_cache::0","time":{"start":1764177509676,"stop":1764177509676,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"global_fake_fs::0","time":{"start":1764177509677,"stop":1764177509678,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"insert_assert_maybe_fail::0","time":{"start":1764177509679,"stop":1764177509679,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"httpx_mock::0","time":{"start":1764177509855,"stop":1764177509858,"duration":3},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"monkeypatch::0","time":{"start":1764177509859,"stop":1764177509859,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"insert_assert_session::0","time":{"start":1764177580940,"stop":1764177580940,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"labels":[{"name":"parentSuite","value":"tests.unit.async_db"},{"name":"suite","value":"test_caching"},{"name":"host","value":"runnervmg1sw1"},{"name":"thread","value":"2455-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.unit.async_db.test_caching"},{"name":"resultFormat","value":"allure2"}],"parameters":[],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Test defects","matchedStatuses":[],"flaky":false}],"tags":[]},"source":"3d47195d2c12c9d5.json","parameterValues":[]}